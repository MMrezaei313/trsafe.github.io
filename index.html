<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mousa Trading - سیستم آنلاین پیشرفته</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Tahoma, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .login-box {
            max-width: 100%;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #1e3a8a;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .main-app {
            display: none;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .app-header {
            background: #1f2937;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .app-header h2 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .market-ticker {
            background: #374151;
            padding: 8px;
            overflow: hidden;
            font-size: 0.85rem;
        }
        
        .ticker-content {
            display: flex;
            animation: ticker 30s linear infinite;
        }
        
        .ticker-item {
            margin: 0 15px;
            white-space: nowrap;
        }
        
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            min-height: 80vh;
        }
        
        .sidebar {
            background: #1f2937;
            color: white;
            padding: 15px;
            display: none;
        }
        
        .sidebar.active {
            display: block;
        }
        
        .main-content {
            padding: 15px;
            overflow-y: auto;
        }
        
        .menu-item {
            padding: 12px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
            font-size: 0.95rem;
        }
        
        .menu-item:hover, .menu-item.active {
            background: #374151;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .price-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #e5e7eb;
            text-align: center;
        }
        
        .current-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
            margin: 8px 0;
        }
        
        .price-change {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .positive { background: #dcfce7; color: #166534; }
        .negative { background: #fecaca; color: #dc2626; }
        
        .calculator {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .result-card {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        
        .profit { color: #10b981; }
        .loss { color: #ef4444; }
        
        .loading {
            text-align: center;
            padding: 15px;
            color: #6b7280;
        }
        
        .connection-status {
            padding: 8px;
            border-radius: 5px;
            margin: 8px 0;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .online { background: #dcfce7; color: #166534; }
        .offline { background: #fecaca; color: #dc2626; }

        .admin-panel {
            background: #fffbeb;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .module-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #10b981;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .api-connections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .api-connection {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .connection-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .connection-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
        
        .connection-status-dot.offline {
            background: #ef4444;
        }
        
        .connection-status-dot.warning {
            background: #f59e0b;
        }
        
        .module-status {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 20px;
            background: #dcfce7;
            color: #166534;
        }
        
        .status-offline {
            background: #fecaca;
            color: #dc2626;
        }
        
        .advanced-analysis-form {
            position: relative;
            min-height: 400px;
        }
        
        .form-step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .form-step.active {
            display: block;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        .selection-summary {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .summary-item {
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        
        .final-prediction {
            background: linear-gradient(135deg, #10b981, #22c55e);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .final-prediction.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .final-prediction.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .probability-circle {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            margin: 10px auto;
        }
        
        .circle-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .circle-label {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .decision-text {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .trading-targets-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .target-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 2px solid #e5e7eb;
        }
        
        .target-card.profit {
            border-color: #10b981;
        }
        
        .target-card.loss {
            border-color: #ef4444;
        }
        
        .target-card.time {
            border-color: #f59e0b;
        }
        
        .target-card.risk {
            border-color: #3b82f6;
        }
        
        .target-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .target-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .target-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1f2937;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .analysis-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .analysis-score {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .analysis-score.good {
            color: #10b981;
        }
        
        .analysis-score.average {
            color: #f59e0b;
        }
        
        .analysis-score.poor {
            color: #ef4444;
        }
        
        .recommendation-list {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e5e7eb;
        }
        
        .recommendation-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }
        
        .recommendation-item:last-child {
            border-bottom: none;
        }
        
        .recommendation-item i {
            color: #10b981;
            margin-left: 8px;
        }
        
        .risk-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 15px;
            border-radius: 10px;
            border-right: 4px solid #f59e0b;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .data-source-selector {
            background: #f8fafc;
            padding: 12px;
            border-radius: 10px;
            margin: 12px 0;
            border: 1px solid #e5e7eb;
        }
        
        .source-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .source-option {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .source-option:hover {
            border-color: #3b82f6;
        }
        
        .source-option.active {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }
        
        .api-status {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
            margin-right: 5px;
        }
        
        .api-live {
            background: #dcfce7;
            color: #166534;
        }
        
        .api-offline {
            background: #fecaca;
            color: #dc2626;
        }
        
        .analysis-status {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        
        .analysis-live {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #10b981;
        }
        
        .analysis-offline {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        
        .api-test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .api-success {
            background: #f0fdf4;
            color: #166534;
            border-right: 4px solid #10b981;
        }
        
        .api-error {
            background: #fef2f2;
            color: #dc2626;
            border-right: 4px solid #ef4444;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ریسپانسیو برای موبایل */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                right: 0;
                width: 80%;
                height: 100%;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                overflow-y: auto;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }
            
            .overlay.active {
                display: block;
            }
            
            .prediction-main {
                flex-direction: column;
                gap: 15px;
            }
            
            .trading-targets-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .analysis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .source-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ریسپانسیو برای تبلت */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                display: block;
            }
            
            .menu-toggle {
                display: none;
            }
            
            .dashboard {
                grid-template-columns: 250px 1fr;
            }
            
            .trading-targets-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .analysis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ریسپانسیو برای دسکتاپ */
        @media (min-width: 1025px) {
            .sidebar {
                display: block;
            }
            
            .menu-toggle {
                display: none;
            }
            
            .dashboard {
                grid-template-columns: 250px 1fr;
            }
            
            .trading-targets-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .results-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .analysis-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .summary-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .source-options {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- صفحه لاگین -->
        <div class="login-box" id="loginPage">
            <h2>Mousa Trading Advisor</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>نام کاربری</label>
                    <input type="text" id="username" class="form-control" required value="admin">
                </div>
                <div class="form-group">
                    <label>رمز عبور</label>
                    <input type="password" id="password" class="form-control" required value="mousa123">
                </div>
                <button type="submit" class="btn">ورود به سیستم</button>
            </form>
            <div style="margin-top: 15px; font-size: 12px; text-align: center; color: #6b7280;">
                <strong>اطلاعات تست:</strong> admin / mousa123
            </div>
        </div>

        <!-- برنامه اصلی -->
        <div class="main-app" id="mainApp">
            <div class="app-header">
                <h2>Mousa Trading System 
                    <span class="real-time-indicator"></span>
                    <span class="api-status api-live">LIVE</span>
                </h2>
                <div class="header-controls">
                    <span id="currentTime">--:--:--</span>
                    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
                    <button class="btn" onclick="logout()" style="width: auto; margin-left: 10px; padding: 8px 12px;">خروج</button>
                </div>
            </div>

            <!-- تیکر بازار -->
            <div class="market-ticker">
                <div class="ticker-content" id="tickerContent">
                    <!-- قیمت های زنده اینجا نمایش داده می شوند -->
                </div>
            </div>

            <div class="dashboard">
                <!-- نوار کناری -->
                <div class="sidebar" id="sidebar">
                    <h3>منوی سیستم</h3>
                    <div class="menu-item active" onclick="showTab('tab-market')">📊 بازار زنده</div>
                    <div class="menu-item" onclick="showTab('tab-analysis')">🧠 تحلیل پیشرفته</div>
                    <div class="menu-item" onclick="showTab('tab-calculator')">🧮 ماشین حساب معاملاتی</div>
                    <div class="menu-item" onclick="showTab('tab-admin')">⚙️ پنل مدیریت</div>
                    <div class="menu-item" onclick="showTab('tab-advanced')">🤖 هوش مصنوعی Mousa</div>
                    <div class="menu-item" onclick="showTab('tab-news')">📰 اخبار مالی</div>
                    <div class="menu-item" onclick="showTab('tab-saved-analyses')" id="adminSavedAnalyses">📊 تحلیل‌های ذخیره شده</div>
                    
                    <div style="margin-top: 30px;">
                        <div class="connection-status online" id="connectionStatus">
                            🔗 آنلاین - اتصال برقرار
                        </div>
                        <div style="font-size: 12px; color: #9ca3af; margin-top: 10px;">
                            آخرین بروزرسانی: <span id="lastUpdate">--:--:--</span>
                        </div>
                    </div>
                </div>

                <!-- محتوای اصلی -->
                <div class="main-content">
                    <!-- تب بازار زنده -->
                    <div class="tab-content active" id="tab-market">
                        <h2>بازار زنده</h2>
                        
                        <!-- انتخاب منبع داده -->
                        <div class="data-source-selector">
                            <h4>📡 انتخاب منبع داده</h4>
                            <div class="source-options">
                                <div class="source-option active" onclick="selectDataSource('coingecko')">
                                    <div>🪙 CoinGecko</div>
                                    <small>ارزهای دیجیتال</small>
                                </div>
                                <div class="source-option" onclick="selectDataSource('binance')">
                                    <div>💎 Binance</div>
                                    <small>دقیق‌ترین قیمت‌ها</small>
                                </div>
                                <div class="source-option" onclick="selectDataSource('alphavantage')">
                                    <div>💵 Alpha Vantage</div>
                                    <small>فارکس و سهام</small>
                                </div>
                                <div class="source-option" onclick="selectDataSource('tsetmc')">
                                    <div>📈 TSETMC</div>
                                    <small>بورس تهران</small>
                                </div>
                            </div>
                        </div>

                        <div class="loading" id="marketLoading">
                            در حال دریافت داده های بازار...
                        </div>
                        <div id="marketData" style="display: none;">
                            <!-- داده های بازار اینجا نمایش داده می شوند -->
                        </div>
                    </div>

                    <!-- تب تحلیل پیشرفته -->
                    <div class="tab-content" id="tab-analysis">
                        <h2>🧠 تحلیل پیشرفته Mousa</h2>
                        
                        <div class="calculator">
                            <div class="advanced-analysis-form">
                                <!-- مرحله 1: انتخاب نماد -->
                                <div class="form-step active" id="analysisStep1">
                                    <h4>📈 مرحله 1: انتخاب نماد</h4>
                                    <div class="form-group">
                                        <label>نماد معاملاتی</label>
                                        <select id="analysisSymbol" class="form-control">
                                            <option value="">-- لطفا نماد را انتخاب کنید --</option>
                                        </select>
                                    </div>
                                    <button class="btn" onclick="nextAnalysisStep(1)">
                                        مرحله بعد
                                    </button>
                                </div>

                                <!-- مرحله 2: تنظیمات سرمایه -->
                                <div class="form-step" id="analysisStep2">
                                    <h4>💵 مرحله 2: تنظیمات سرمایه</h4>
                                    <div class="form-group">
                                        <label>مقدار سرمایه (دلار)</label>
                                        <input type="number" id="analysisAmount" class="form-control" value="1000" min="10">
                                    </div>
                                    <div class="form-group">
                                        <label>اهرم</label>
                                        <select id="analysisLeverage" class="form-control">
                                            <option value="1">1x</option>
                                            <option value="5">5x</option>
                                            <option value="10">10x</option>
                                            <option value="20">20x</option>
                                        </select>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn" onclick="prevAnalysisStep(2)">
                                            مرحله قبل
                                        </button>
                                        <button class="btn" onclick="runAdvancedAnalysis()">
                                            اجرای تحلیل پیشرفته
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="analysisResults" style="display: none;">
                                <h4>نتایج تحلیل Mousa</h4>
                                <div id="resultsContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- تب ماشین حساب -->
                    <div class="tab-content" id="tab-calculator">
                        <h2>ماشین حساب معاملاتی</h2>
                        <div class="calculator">
                            <div>
                                <h4>ورودی ها</h4>
                                <div class="form-group">
                                    <label>نماد معاملاتی</label>
                                    <select id="calcSymbol" class="form-control" onchange="updateCalcPrice()">
                                        <option value="bitcoin">بیت‌کوین (BTC)</option>
                                        <option value="ethereum">اتریوم (ETH)</option>
                                        <option value="binancecoin">بایننس کوین (BNB)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>سرمایه اولیه (دلار)</label>
                                    <input type="number" id="calcAmount" class="form-control" value="1000" min="10">
                                </div>
                                
                                <div class="form-group">
                                    <label>نوع پوزیشن</label>
                                    <select id="calcPosition" class="form-control">
                                        <option value="long">لانگ (خرید)</option>
                                        <option value="short">شورت (فروش)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>اهرم: <span id="calcLeverageValue">5x</span></label>
                                    <input type="range" id="calcLeverage" class="form-control" min="1" max="20" value="5" oninput="updateCalcLeverage()">
                                </div>
                                
                                <div class="form-group">
                                    <label>تغییر قیمت مورد انتظار (%)</label>
                                    <input type="number" id="calcPriceChange" class="form-control" value="10" step="0.1">
                                </div>
                            </div>
                            
                            <div>
                                <h4>نتایج محاسبات</h4>
                                <div class="results-grid">
                                    <div class="result-card">
                                        <div>سرمایه اولیه</div>
                                        <div id="calcInitial">$1,000</div>
                                    </div>
                                    <div class="result-card">
                                        <div>سرمایه با اهرم</div>
                                        <div id="calcLeveraged">$5,000</div>
                                    </div>
                                    <div class="result-card">
                                        <div>سود احتمالی</div>
                                        <div id="calcProfit" class="profit">+$500</div>
                                    </div>
                                    <div class="result-card">
                                        <div>ضرر احتمالی</div>
                                        <div id="calcLoss" class="loss">-$500</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button class="btn" onclick="calculateTrade()">محاسبه سود/ضرر</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تب پنل مدیریت -->
                    <div class="tab-content" id="tab-admin">
                        <h2>پنل مدیریت Mousa</h2>
                        <div class="admin-panel">
                            <h3>🛡️ کنترل ماژول‌های پیشرفته</h3>
                            <p>تنظیمات پیشرفته سیستم - فقط برای مدیران سیستم</p>
                            
                            <!-- وضعیت اتصال API -->
                            <div style="margin-top: 20px;">
                                <h4>🔗 وضعیت اتصال API</h4>
                                <div class="api-connections" id="apiConnections">
                                    <!-- اتصالات API اینجا نمایش داده می‌شوند -->
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h4>کنترل ماژول‌های تحلیلی</h4>
                                <div class="module-controls">
                                    <div class="control-item">
                                        <span>هوش مصنوعی پیشرفته</span>
                                        <label class="switch">
                                            <input type="checkbox" id="toggleEnhancedAI" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="control-item">
                                        <span>تحلیل اخبار رویترز</span>
                                        <label class="switch">
                                            <input type="checkbox" id="toggleReuters" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="control-item">
                                        <span>تحلیل اخبار بی‌بی‌سی</span>
                                        <label class="switch">
                                            <input type="checkbox" id="toggleBBC" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="control-item">
                                        <span>تحلیل حجم معاملات</span>
                                        <label class="switch">
                                            <input type="checkbox" id="toggleVolumeAnalysis" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="control-item">
                                        <span>تحلیل تکنیکال پیشرفته</span>
                                        <label class="switch">
                                            <input type="checkbox" id="toggleTechnical" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="control-item">
                                        <span>تحلیل سنتیمنت بازار</span>
                                        <label class="switch">
                                            <input type="checkbox" id="toggleSentiment" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تب هوش مصنوعی Mousa -->
                    <div class="tab-content" id="tab-advanced">
                        <h2>🤖 هوش مصنوعی Mousa - تحلیل چندمرحله‌ای</h2>
                        
                        <div class="calculator">
                            <div class="advanced-analysis-form">
                                <!-- مرحله 1: انتخاب بازار -->
                                <div class="form-step active" id="step1">
                                    <h4>📈 مرحله 1: انتخاب بازار</h4>
                                    <div class="form-group">
                                        <label>بازار مورد نظر</label>
                                        <select class="form-control" id="marketSelect">
                                            <option value="">-- لطفا بازار را انتخاب کنید --</option>
                                            <option value="crypto">ارزهای دیجیتال</option>
                                            <option value="forex">فارکس</option>
                                            <option value="stocks">بورس سهام</option>
                                            <option value="commodities">کالاها</option>
                                        </select>
                                    </div>
                                    <button class="btn" onclick="nextStep(1)">
                                        مرحله بعد
                                    </button>
                                </div>

                                <!-- مرحله 2: انتخاب نماد -->
                                <div class="form-step" id="step2">
                                    <h4>🏷️ مرحله 2: انتخاب نماد</h4>
                                    <div class="form-group">
                                        <label>نماد معاملاتی</label>
                                        <select class="form-control" id="symbolSelect">
                                            <option value="">-- لطفا نماد را انتخاب کنید --</option>
                                            <!-- نمادها بر اساس بازار پر می‌شوند -->
                                        </select>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn" onclick="prevStep(2)">
                                            مرحله قبل
                                        </button>
                                        <button class="btn" onclick="nextStep(2)">
                                            مرحله بعد
                                        </button>
                                    </div>
                                </div>

                                <!-- مرحله 3: مقدار سرمایه‌گذاری -->
                                <div class="form-step" id="step3">
                                    <h4>💵 مرحله 3: مقدار سرمایه‌گذاری</h4>
                                    <div class="form-group">
                                        <label>مقدار سرمایه (دلار)</label>
                                        <input type="number" class="form-control" id="investmentAmount" 
                                               placeholder="مثال: 1000" min="10" step="10" value="1000">
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn" onclick="prevStep(3)">
                                            مرحله قبل
                                        </button>
                                        <button class="btn" onclick="nextStep(3)">
                                            مرحله بعد
                                        </button>
                                    </div>
                                </div>

                                <!-- مرحله 4: زمان رسیدن به نتیجه -->
                                <div class="form-step" id="step4">
                                    <h4>⏰ مرحله 4: زمان رسیدن به نتیجه</h4>
                                    <div class="form-group">
                                        <label>بازه زمانی مورد نظر</label>
                                        <select class="form-control" id="timeframeSelect">
                                            <option value="">-- لطفا بازه زمانی را انتخاب کنید --</option>
                                            <option value="5min">5 دقیقه</option>
                                            <option value="15min">15 دقیقه</option>
                                            <option value="1h">1 ساعت</option>
                                            <option value="4h">4 ساعت</option>
                                            <option value="1d">1 روز</option>
                                            <option value="3d">3 روز</option>
                                            <option value="1w">1 هفته</option>
                                        </select>
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn" onclick="prevStep(4)">
                                            مرحله قبل
                                        </button>
                                        <button class="btn" onclick="runMousaAIAnalysis()">
                                            اجرای تحلیل هوش مصنوعی
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- خلاصه انتخاب‌ها -->
                            <div id="selectionSummary" class="selection-summary" style="display: none; margin-top: 20px;">
                                <h5>📋 خلاصه انتخاب‌های شما:</h5>
                                <div id="summaryContent"></div>
                            </div>

                            <!-- نتایج تحلیل -->
                            <div id="mousaAIResults" style="display: none; margin-top: 30px;"></div>
                        </div>
                    </div>

                    <!-- تب اخبار مالی -->
                    <div class="tab-content" id="tab-news">
                        <h2>📰 اخبار مالی لحظه‌ای</h2>
                        <div class="data-source-selector">
                            <h4>منبع اخبار</h4>
                            <div class="source-options">
                                <div class="source-option active" onclick="selectNewsSource('reuters')">
                                    <div>🌍 رویترز</div>
                                    <small>اخبار بین‌المللی</small>
                                </div>
                                <div class="source-option" onclick="selectNewsSource('bbc')">
                                    <div>📻 بی‌بی‌سی</div>
                                    <small>اخبار جهانی</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="loading" id="newsLoading">
                            در حال دریافت آخرین اخبار...
                        </div>
                        <div id="newsData" style="display: none;">
                            <!-- اخبار اینجا نمایش داده می‌شوند -->
                        </div>
                    </div>

                    <!-- تب تحلیل‌های ذخیره شده -->
                    <div class="tab-content" id="tab-saved-analyses">
                        <h2>📊 تحلیل‌های ذخیره شده - پنل مدیریت</h2>
                        
                        <div class="admin-panel">
                            <h4>تاریخچه تحلیل‌های انجام شده</h4>
                            
                            <div style="margin-bottom: 15px;">
                                <button class="btn" onclick="loadSavedAnalyses()" style="width: auto; margin-left: 10px;">
                                    🔄 بروزرسانی
                                </button>
                                <button class="btn" onclick="clearAllAnalyses()" style="width: auto; background: #ef4444;">
                                    🗑️ حذف همه
                                </button>
                            </div>
                            
                            <div id="savedAnalysesList">
                                <!-- لیست تحلیل‌های ذخیره شده -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- overlay برای منوی موبایل -->
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    </div>

    <script>
        // API Keys واقعی - در محیط تولید باید از سرور امن استفاده شود
        const ALPHA_VANTAGE_API_KEY = 'demo'; // برای تست
        const NEWS_API_KEY = 'pub_1234567890abcdef'; // کلید نمونه
        const COINGECKO_API_URL = 'https://api.coingecko.com/api/v3';
        const BINANCE_API_URL = 'https://api.binance.com/api/v3';

        // منابع داده
        let currentDataSource = 'coingecko';
        let currentNewsSource = 'reuters';
        let currentPrices = {};
        let updateInterval;
        let currentStep = 1;
        let currentAnalysisStep = 1;
        let userSelections = {};
        let isOnline = true;

        // داده‌های نمادها برای هر بازار
        const symbolsData = {
            crypto: [
                'بیت‌کوین (BTC)', 'اتریوم (ETH)', 'بایننس کوین (BNB)', 
                'ریپل (XRP)', 'کاردانو (ADA)', 'سولانا (SOL)', 'دوج کوین (DOGE)'
            ],
            forex: [
                'EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CAD',
                'USD/CHF', 'NZD/USD', 'EUR/GBP'
            ],
            stocks: [
                'اپل (AAPL)', 'مایکروسافت (MSFT)', 'آمازون (AMZN)', 
                'تسلا (TSLA)', 'فیسبوک (META)', 'گوگل (GOOGL)',
                'نفتیا (NFLX)', 'نویدیا (NVDA)'
            ],
            commodities: [
                'طلا (XAU)', 'نقره (XAG)', 'نفت خام (OIL)', 
                'گاز طبیعی (GAS)', 'مس (COPPER)', 'قهوه (COFFEE)'
            ]
        };

        // مدیریت لاگین
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === "admin" && password === "mousa123") {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initializeApp();
            } else {
                alert('نام کاربری یا رمز عبور اشتباه است!');
            }
        });

        // نمایش/پنهان کردن منو در موبایل
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // مقداردهی اولیه برنامه
        async function initializeApp() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // تست اتصال به APIها
            await testAPIConnections();
            
            // بارگذاری نمادهای اولیه
            await loadExchangeSymbols(currentDataSource);
            
            // شروع به روزرسانی داده های بازار
            await loadMarketData();
            updateInterval = setInterval(loadMarketData, 30000);
            
            // محاسبه اولیه
            calculateTrade();
            
            // تنظیم کنترل‌های ماژول
            setupModuleControls();
            
            // بارگذاری وضعیت APIها
            loadAPIStatus();
            
            // بارگذاری اخبار واقعی
            await loadRealNewsData();
        }

        // تست اتصال به APIهای مختلف
        async function testAPIConnections() {
            const statusIndicator = document.querySelector('.api-status');
            const realTimeIndicator = document.querySelector('.real-time-indicator');
            
            try {
                // تست CoinGecko
                const coingeckoTest = await fetch(`${COINGECKO_API_URL}/ping`);
                if (!coingeckoTest.ok) throw new Error('CoinGecko API Error');
                
                // تست Binance
                const binanceTest = await fetch(`${BINANCE_API_URL}/ping`);
                if (!binanceTest.ok) throw new Error('Binance API Error');
                
                isOnline = true;
                statusIndicator.textContent = 'LIVE';
                statusIndicator.className = 'api-status api-live';
                realTimeIndicator.style.background = '#10b981';
                
            } catch (error) {
                console.error('API Connection Error:', error);
                isOnline = false;
                statusIndicator.textContent = 'OFFLINE';
                statusIndicator.className = 'api-status api-offline';
                realTimeIndicator.style.background = '#ef4444';
                
                showNotification('⚠️ سیستم در حالت آفلاین کار می‌کند. برخی قابلیت‌ها محدود هستند.');
            }
        }

        // انتخاب منبع داده
        function selectDataSource(source) {
            currentDataSource = source;
            
            // به‌روزرسانی ظاهر
            document.querySelectorAll('.source-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.source-option').classList.add('active');
            
            // بارگذاری نمادهای مربوط به صرافی انتخاب شده
            loadExchangeSymbols(source);
            
            // بارگذاری داده‌های جدید
            loadMarketData();
        }

        // بارگذاری نمادهای صرافی
        async function loadExchangeSymbols(exchange) {
            console.log('در حال بارگذاری نمادهای صرافی:', exchange);
            
            const symbolSelects = [
                document.getElementById('analysisSymbol'),
                document.getElementById('calcSymbol'),
                document.getElementById('symbolSelect') // برای هوش مصنوعی
            ];
            
            // پاک کردن گزینه‌های قبلی
            symbolSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">در حال بارگذاری نمادها...</option>';
                }
            });
            
            try {
                let symbols = [];
                
                switch(exchange) {
                    case 'binance':
                        symbols = await loadBinanceSymbols();
                        break;
                    case 'coingecko':
                        symbols = await loadCoinGeckoSymbols();
                        break;
                    case 'alphavantage':
                        symbols = await loadAlphaVantageSymbols();
                        break;
                    case 'tsetmc':
                        symbols = await loadTSETMCSymbols();
                        break;
                    default:
                        symbols = getDefaultSymbols();
                }
                
                // پر کردن selectها
                symbolSelects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">لطفا نماد را انتخاب کنید</option>';
                        symbols.forEach(symbol => {
                            const option = document.createElement('option');
                            option.value = symbol.id;
                            option.textContent = symbol.name + (symbol.symbol ? ` (${symbol.symbol})` : '');
                            select.appendChild(option);
                        });
                    }
                });
                
                showNotification(`✅ نمادهای ${exchange} بارگذاری شدند`);
                
            } catch (error) {
                console.error('Error loading symbols:', error);
                loadDefaultSymbols();
                showNotification('⚠️ خطا در بارگذاری نمادها. از نمادهای پیش‌فرض استفاده می‌شود.');
            }
        }

        // نمادهای Binance
        async function loadBinanceSymbols() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
                const data = await response.json();
                
                return data.symbols
                    .filter(s => s.status === 'TRADING' && s.symbol.endsWith('USDT'))
                    .slice(0, 20)
                    .map(s => ({
                        id: s.symbol.toLowerCase().replace('usdt', ''),
                        name: s.baseAsset,
                        symbol: s.symbol
                    }));
            } catch (error) {
                return getDefaultCryptoSymbols();
            }
        }

        // نمادهای CoinGecko
        async function loadCoinGeckoSymbols() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=20&page=1');
                const data = await response.json();
                
                return data.map(coin => ({
                    id: coin.id,
                    name: coin.name,
                    symbol: coin.symbol.toUpperCase()
                }));
            } catch (error) {
                return getDefaultCryptoSymbols();
            }
        }

        // نمادهای Alpha Vantage
        async function loadAlphaVantageSymbols() {
            return [
                { id: 'AAPL', name: 'اپل', symbol: 'AAPL' },
                { id: 'MSFT', name: 'مایکروسافت', symbol: 'MSFT' },
                { id: 'GOOGL', name: 'گوگل', symbol: 'GOOGL' },
                { id: 'AMZN', name: 'آمازون', symbol: 'AMZN' },
                { id: 'TSLA', name: 'تسلا', symbol: 'TSLA' },
                { id: 'EUR/USD', name: 'یورو/دلار', symbol: 'EURUSD' },
                { id: 'GBP/USD', name: 'پوند/دلار', symbol: 'GBPUSD' }
            ];
        }

        // نمادهای TSETMC
        async function loadTSETMCSymbols() {
            return [
                { id: 'شاخص کل', name: 'شاخص کل بورس' },
                { id: 'فملی', name: 'فولاد مبارکه' },
                { id: 'فولاد', name: 'فولاد خوزستان' },
                { id: 'کگل', name: 'کگل' },
                { id: 'وبصادر', name: 'وبصادر' }
            ];
        }

        // نمادهای پیش‌فرض
        function getDefaultCryptoSymbols() {
            return [
                { id: 'bitcoin', name: 'بیت‌کوین', symbol: 'BTC' },
                { id: 'ethereum', name: 'اتریوم', symbol: 'ETH' },
                { id: 'binancecoin', name: 'بایننس کوین', symbol: 'BNB' },
                { id: 'ripple', name: 'ریپل', symbol: 'XRP' },
                { id: 'cardano', name: 'کاردانو', symbol: 'ADA' },
                { id: 'solana', name: 'سولانا', symbol: 'SOL' },
                { id: 'polkadot', name: 'پولکادات', symbol: 'DOT' },
                { id: 'dogecoin', name: 'دوج کوین', symbol: 'DOGE' }
            ];
        }

        function loadDefaultSymbols() {
            const symbolSelects = [
                document.getElementById('analysisSymbol'),
                document.getElementById('calcSymbol'),
                document.getElementById('symbolSelect')
            ];
            
            const defaultSymbols = getDefaultCryptoSymbols();
            
            symbolSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">لطفا نماد را انتخاب کنید</option>';
                    defaultSymbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol.id;
                        option.textContent = symbol.name + (symbol.symbol ? ` (${symbol.symbol})` : '');
                        select.appendChild(option);
                    });
                }
            });
        }

        // انتخاب منبع اخبار
        function selectNewsSource(source) {
            currentNewsSource = source;
            
            // به‌روزرسانی ظاهر
            document.querySelectorAll('.source-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.source-option').classList.add('active');
            
            // بارگذاری اخبار جدید
            loadNewsData();
        }

        // بارگذاری وضعیت APIها
        function loadAPIStatus() {
            const apiConnections = [
                { name: 'CoinGecko API', status: isOnline ? 'online' : 'offline' },
                { name: 'Binance API', status: isOnline ? 'online' : 'offline' },
                { name: 'Alpha Vantage API', status: isOnline ? 'online' : 'offline' },
                { name: 'News API', status: isOnline ? 'online' : 'offline' }
            ];

            let html = '';
            apiConnections.forEach(api => {
                html += `
                    <div class="api-connection">
                        <div class="connection-details">
                            <div class="connection-status-dot ${api.status}"></div>
                            <span>${api.name}</span>
                        </div>
                        <span class="module-status ${api.status === 'online' ? '' : 'status-offline'}">
                            ${api.status === 'online' ? 'آنلاین' : 'آفلاین'}
                        </span>
                    </div>
                `;
            });

            document.getElementById('apiConnections').innerHTML = html;
        }

        // تنظیم کنترل‌های ماژول
        function setupModuleControls() {
            const toggles = [
                'toggleEnhancedAI', 'toggleReuters', 'toggleBBC',
                'toggleVolumeAnalysis', 'toggleTechnical', 'toggleSentiment'
            ];
            
            toggles.forEach(toggleId => {
                const toggleElement = document.getElementById(toggleId);
                if (toggleElement) {
                    toggleElement.addEventListener('change', function() {
                        const status = this.checked ? 'فعال' : 'غیرفعال';
                        const moduleName = this.parentElement.previousElementSibling.textContent;
                        showNotification(`ماژول ${moduleName} ${status} شد`);
                    });
                }
            });
        }

        // نمایش نوتیفیکیشن
        function showNotification(message) {
            // ایجاد یک نوتیفیکیشن موقت
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // به روزرسانی زمان
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('fa-IR');
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('fa-IR');
        }

        // نمایش تب ها
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            // اگر تب بازار است، داده ها را به روز کن
            if (tabId === 'tab-market') {
                loadMarketData();
            } else if (tabId === 'tab-news') {
                loadNewsData();
            } else if (tabId === 'tab-saved-analyses') {
                loadSavedAnalyses();
            }
            
            // در موبایل، پس از انتخاب تب منو را ببند
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // خروج
        function logout() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            clearInterval(updateInterval);
        }

        // دریافت داده های بازار از APIهای مختلف
        async function loadMarketData() {
            try {
                document.getElementById('connectionStatus').className = 'connection-status online';
                document.getElementById('connectionStatus').innerHTML = '🔗 آنلاین - در حال دریافت داده ها...';
                
                let data = {};
                
                switch(currentDataSource) {
                    case 'coingecko':
                        data = await loadCoinGeckoData();
                        break;
                    case 'binance':
                        data = await loadBinanceData();
                        break;
                    case 'alphavantage':
                        data = await loadAlphaVantageData();
                        break;
                    case 'tsetmc':
                        data = await loadTSETMCData();
                        break;
                }
                
                currentPrices = data;
                displayMarketData(data);
                updateTicker(data);
                
                document.getElementById('connectionStatus').innerHTML = '🔗 آنلاین - اتصال برقرار';
                
            } catch (error) {
                console.error('Error fetching market data:', error);
                document.getElementById('connectionStatus').className = 'connection-status offline';
                document.getElementById('connectionStatus').innerHTML = '🔴 آفلاین - خطا در دریافت داده ها';
            }
        }

        // دریافت داده از CoinGecko
        async function loadCoinGeckoData() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,ripple,cardano&vs_currencies=usd&include_24hr_change=true');
                if (!response.ok) throw new Error('CoinGecko API Error');
                return await response.json();
            } catch (error) {
                console.error('CoinGecko API Error:', error);
                // داده‌های نمونه
                return {
                    bitcoin: { usd: 45000, usd_24h_change: 2.5 },
                    ethereum: { usd: 3200, usd_24h_change: 1.8 },
                    binancecoin: { usd: 580, usd_24h_change: -0.5 },
                    ripple: { usd: 0.75, usd_24h_change: 3.2 },
                    cardano: { usd: 1.2, usd_24h_change: -1.2 }
                };
            }
        }

        // دریافت داده از Binance
        async function loadBinanceData() {
            try {
                const symbols = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'XRPUSDT', 'ADAUSDT'];
                const data = {};
                
                for (const symbol of symbols) {
                    try {
                        const response = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
                        if (!response.ok) continue;
                        
                        const ticker = await response.json();
                        
                        const coinId = symbol.replace('USDT', '').toLowerCase();
                        if (coinId === 'bnb') coinId = 'binancecoin';
                        
                        data[coinId] = {
                            usd: parseFloat(ticker.lastPrice),
                            usd_24h_change: parseFloat(ticker.priceChangePercent)
                        };
                    } catch (error) {
                        console.error(`Error fetching ${symbol}:`, error);
                    }
                }
                
                return data;
            } catch (error) {
                console.error('Binance API Error:', error);
                return loadCoinGeckoData(); // بازگشت به CoinGecko
            }
        }

        // دریافت داده از Alpha Vantage
        async function loadAlphaVantageData() {
            // داده‌های نمونه برای فارکس و سهام
            return {
                'eur/usd': { usd: 1.0850, usd_24h_change: 0.15 },
                'gbp/usd': { usd: 1.2650, usd_24h_change: -0.25 },
                'aapl': { usd: 185.50, usd_24h_change: 1.2 },
                'msft': { usd: 420.75, usd_24h_change: 0.8 }
            };
        }

        // دریافت داده از TSETMC
        async function loadTSETMCData() {
            // داده‌های نمونه برای بورس تهران
            return {
                'شاخص کل': { usd: 2100000, usd_24h_change: 1.2 },
                'شاخص هم وزن': { usd: 480000, usd_24h_change: 0.8 },
                'فملی': { usd: 45000, usd_24h_change: -0.5 },
                'فولاد': { usd: 38000, usd_24h_change: 1.8 }
            };
        }

        // دریافت اخبار واقعی
        async function loadRealNewsData() {
            try {
                const newsLoading = document.getElementById('newsLoading');
                const newsData = document.getElementById('newsData');
                
                newsLoading.style.display = 'block';
                newsData.style.display = 'none';
                
                // استفاده از API رایگان برای اخبار
                const response = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://rss.cnn.com/rss/edition.rss');
                
                if (response.ok) {
                    const data = await response.json();
                    const news = data.items.slice(0, 6).map(item => ({
                        title: item.title,
                        description: item.description.replace(/<[^>]*>/g, '').substring(0, 150) + '...',
                        source: 'CNN',
                        time: formatTimeAgo(item.pubDate),
                        url: item.link
                    }));
                    
                    displayNewsData(news);
                } else {
                    throw new Error('News API failed');
                }
                
                newsLoading.style.display = 'none';
                newsData.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching real news:', error);
                loadFallbackNews();
            }
        }

        // اخبار پشتیبان
        function loadFallbackNews() {
            const news = [
                {
                    title: 'بازار ارزهای دیجیتال با رشد مثبت روبرو شد',
                    description: 'قیمت بیت‌کوین و اتریوم در ۲۴ ساعت گذشته رشد قابل توجهی را تجربه کردند.',
                    source: 'Mousa Trading',
                    time: 'هم اکنون',
                    url: '#'
                },
                {
                    title: 'تحلیل‌گران پیش‌بینی رشد برای بازار سهام',
                    description: 'کارشناسان معتقدند شاخص‌های اصلی بورس در هفته آینده روند صعودی خواهند داشت.',
                    source: 'Mousa Trading',
                    time: '۱ ساعت پیش',
                    url: '#'
                },
                {
                    title: 'نوسانات قیمت نفت بر بازار جهانی تاثیر گذاشت',
                    description: 'تحولات سیاسی در خاورمیانه باعث نوسان در قیمت نفت خام شده است.',
                    source: 'Mousa Trading',
                    time: '۲ ساعت پیش',
                    url: '#'
                }
            ];
            displayNewsData(news);
        }

        // بارگذاری اخبار
        async function loadNewsData() {
            await loadRealNewsData();
        }

        // فرمت‌بندی زمان
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'هم اکنون';
            if (diffMins < 60) return `${diffMins} دقیقه پیش`;
            if (diffHours < 24) return `${diffHours} ساعت پیش`;
            return `${Math.floor(diffHours / 24)} روز پیش`;
        }

        // نمایش اخبار
        function displayNewsData(news) {
            const newsDataDiv = document.getElementById('newsData');
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            news.forEach(item => {
                html += `
                    <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border-right: 4px solid #3b82f6;">
                        <h4 style="margin-bottom: 10px; font-size: 1.1rem;">
                            <a href="${item.url}" target="_blank" style="color: inherit; text-decoration: none;">
                                ${item.title}
                            </a>
                        </h4>
                        <p style="color: #6b7280; margin-bottom: 10px; font-size: 0.9rem;">${item.description}</p>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #9ca3af;">
                            <span>منبع: ${item.source}</span>
                            <span>${item.time}</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            newsDataDiv.innerHTML = html;
        }

        // نمایش داده های بازار
        function displayMarketData(data) {
            const marketDataDiv = document.getElementById('marketData');
            const loadingDiv = document.getElementById('marketLoading');
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">';
            
            for (const [coin, info] of Object.entries(data)) {
                const coinName = getCoinName(coin);
                const price = info.usd.toLocaleString();
                const change = info.usd_24h_change.toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSign = change >= 0 ? '+' : '';
                
                html += `
                    <div class="price-card">
                        <h3 style="font-size: 1.1rem;">${coinName}</h3>
                        <div class="current-price">$${price}</div>
                        <div class="price-change ${changeClass}">${changeSign}${change}%</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                            منبع: ${getDataSourceName(currentDataSource)}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            marketDataDiv.innerHTML = html;
            loadingDiv.style.display = 'none';
            marketDataDiv.style.display = 'block';
        }

        // نام منبع داده
        function getDataSourceName(source) {
            const names = {
                'coingecko': 'CoinGecko',
                'binance': 'Binance',
                'alphavantage': 'Alpha Vantage',
                'tsetmc': 'TSETMC'
            };
            return names[source] || source;
        }

        // به روزرسانی تیکر
        function updateTicker(data) {
            const tickerContent = document.getElementById('tickerContent');
            let html = '';
            
            for (const [coin, info] of Object.entries(data)) {
                const coinName = getCoinName(coin);
                const price = info.usd.toLocaleString();
                const change = info.usd_24h_change.toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSign = change >= 0 ? '+' : '';
                
                html += `
                    <div class="ticker-item">
                        <strong>${coinName}:</strong> $${price} 
                        <span class="${changeClass}">(${changeSign}${change}%)</span>
                    </div>
                `;
            }
            
            tickerContent.innerHTML = html + html; // دو بار برای تیکر پیوسته
        }

        // نام کامل ارزها
        function getCoinName(coinId) {
            const names = {
                'bitcoin': 'بیت‌کوین',
                'ethereum': 'اتریوم', 
                'binancecoin': 'بایننس کوین',
                'ripple': 'ریپل',
                'cardano': 'کاردانو',
                'شاخص کل': 'شاخص کل بورس',
                'شاخص هم وزن': 'شاخص هم وزن',
                'فملی': 'فولاد مبارکه',
                'فولاد': 'فولاد خوزستان',
                'eur/usd': 'یورو/دلار',
                'gbp/usd': 'پوند/دلار',
                'aapl': 'اپل',
                'msft': 'مایکروسافت'
            };
            return names[coinId] || coinId;
        }

        // مدیریت مراحل تحلیل پیشرفته
        function nextAnalysisStep(step) {
            if (validateAnalysisStep(step)) {
                document.querySelectorAll('.form-step').forEach(stepEl => {
                    stepEl.classList.remove('active');
                });
                
                currentAnalysisStep = step + 1;
                document.getElementById(`analysisStep${currentAnalysisStep}`).classList.add('active');
            }
        }

        function prevAnalysisStep(step) {
            document.querySelectorAll('.form-step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            currentAnalysisStep = step - 1;
            document.getElementById(`analysisStep${currentAnalysisStep}`).classList.add('active');
        }

        function validateAnalysisStep(step) {
            if (step === 1) {
                const symbol = document.getElementById('analysisSymbol').value;
                if (!symbol) {
                    alert('لطفا نماد معاملاتی را انتخاب کنید');
                    return false;
                }
            }
            return true;
        }

        // تست اتصال به API
        async function testConnection() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/ping');
                return response.ok;
            } catch (error) {
                console.log('اتصال آنلاین برقرار نیست - استفاده از داده‌های نمونه');
                return false;
            }
        }

        // اجرای تحلیل پیشرفته
        async function runAdvancedAnalysis() {
            const symbol = document.getElementById('analysisSymbol').value;
            const amount = parseFloat(document.getElementById('analysisAmount').value);
            const leverage = parseInt(document.getElementById('analysisLeverage').value);
            
            if (!symbol) {
                alert('لطفا یک نماد انتخاب کنید');
                return;
            }
            
            const resultsDiv = document.getElementById('analysisResults');
            const contentDiv = document.getElementById('resultsContent');
            
            // تست اتصال آنلاین
            const isOnline = await testConnection();
            
            // نمایش وضعیت تحلیل
            contentDiv.innerHTML = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin: 12px 0;">
                    <h4>🔍 در حال تحلیل ${getCoinName(symbol)}...</h4>
                    <div class="analysis-status ${isOnline ? 'analysis-live' : 'analysis-offline'}">
                        ${isOnline ? '🟢 تحلیل با داده‌های واقعی' : '🟡 تحلیل با داده‌های نمونه'}
                    </div>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            
            // شبیه‌سازی پردازش
            await simulateAnalysisProgress();
            
            // اجرای تحلیل واقعی یا نمونه
            const analysisResult = isOnline ? 
                await runRealTechnicalAnalysis(symbol) : 
                generateFallbackAnalysis();
            
            // نمایش نتایج
            displayAnalysisResults(analysisResult, symbol, amount, leverage, isOnline);
        }

        // تحلیل تکنیکال واقعی
        async function runRealTechnicalAnalysis(symbol) {
            try {
                console.log('📡 در حال دریافت داده‌های واقعی برای:', symbol);
                
                // دریافت داده‌های واقعی از CoinGecko
                const response = await fetch(
                    `https://api.coingecko.com/api/v3/coins/${symbol}`
                );
                
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                const currentPrice = data.market_data.current_price.usd;
                const priceChange24h = data.market_data.price_change_percentage_24h;
                
                console.log('✅ داده‌های واقعی دریافت شد:', {
                    symbol,
                    price: currentPrice,
                    change: priceChange24h
                });
                
                // تحلیل بر اساس داده‌های واقعی
                return analyzeRealMarketData(currentPrice, priceChange24h);
                
            } catch (error) {
                console.error('خطا در دریافت داده‌های واقعی:', error);
                return generateFallbackAnalysis();
            }
        }

        // تحلیل داده‌های واقعی بازار
        function analyzeRealMarketData(currentPrice, priceChange24h) {
            const volatility = Math.abs(priceChange24h);
            const isUptrend = priceChange24h > 0;
            
            // محاسبه احتمال بر اساس داده‌های واقعی
            let probability = 50; // پایه
            
            if (isUptrend) {
                probability += Math.min(30, priceChange24h * 2);
            } else {
                probability -= Math.min(25, Math.abs(priceChange24h) * 1.5);
            }
            
            probability = Math.max(40, Math.min(90, probability));
            
            return {
                probability: Math.round(probability),
                decision: probability >= 65 ? 'خرید' : probability >= 45 ? 'نگهداری' : 'فروش',
                confidence: volatility < 5 ? 'اطمینان بالا' : 'اطمینان متوسط',
                riskLevel: volatility > 10 ? 'بالا' : volatility > 5 ? 'متوسط' : 'پایین',
                realData: true,
                priceChange: priceChange24h.toFixed(2),
                currentPrice: currentPrice
            };
        }

        // تحلیل پشتیبان
        function generateFallbackAnalysis() {
            const probability = Math.floor(Math.random() * 30) + 65;
            return {
                probability: probability,
                decision: probability >= 75 ? 'خرید' : probability >= 60 ? 'نگهداری' : 'فروش',
                confidence: probability >= 80 ? 'اطمینان بسیار بالا' : 
                            probability >= 70 ? 'اطمینان بالا' : 
                            probability >= 60 ? 'اطمینان متوسط' : 'اطمینان پایین',
                riskLevel: probability >= 80 ? 'پایین' : 
                          probability >= 65 ? 'متوسط' : 'بالا',
                realData: false,
                priceChange: (Math.random() * 10 - 5).toFixed(2),
                currentPrice: (Math.random() * 1000 + 100).toFixed(2)
            };
        }

        // نمایش نتایج تحلیل
        function displayAnalysisResults(analysisResult, symbol, amount, leverage, isOnline) {
            const contentDiv = document.getElementById('resultsContent');
            const profitPotential = (amount * leverage * (analysisResult.probability / 100) * 0.1).toFixed(2);
            const lossPotential = (amount * leverage * ((100 - analysisResult.probability) / 100) * 0.05).toFixed(2);
            
            contentDiv.innerHTML = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin: 12px 0;">
                    <h4 style="font-size: 1.1rem;">
                        📈 تحلیل ${getCoinName(symbol)} 
                        <span class="analysis-status ${isOnline ? 'analysis-live' : 'analysis-offline'}" style="font-size: 0.7rem;">
                            ${isOnline ? '🟢 داده واقعی' : '🟡 داده نمونه'}
                        </span>
                    </h4>
                    
                    ${isOnline ? 
                        '<div class="api-test-result api-success">✅ تحلیل بر اساس داده‌های زنده بازار انجام شد</div>' :
                        '<div class="api-test-result api-error">⚠️ اتصال به سرور برقرار نیست - تحلیل با داده‌های نمونه انجام شد</div>'
                    }
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 12px 0;">
                        <div class="result-card">
                            <div>احتمال موفقیت</div>
                            <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${analysisResult.probability}%</div>
                        </div>
                        <div class="result-card">
                            <div>توصیه Mousa</div>
                            <div style="font-size: 18px; font-weight: bold; color: ${analysisResult.decision === 'خرید' ? '#10b981' : analysisResult.decision === 'فروش' ? '#ef4444' : '#f59e0b'};">${analysisResult.decision}</div>
                        </div>
                        <div class="result-card">
                            <div>سطح ریسک</div>
                            <div style="font-size: 16px; color: ${analysisResult.riskLevel === 'بالا' ? '#ef4444' : analysisResult.riskLevel === 'متوسط' ? '#f59e0b' : '#10b981'};">${analysisResult.riskLevel}</div>
                        </div>
                        <div class="result-card">
                            <div>تغییر قیمت</div>
                            <div style="font-size: 16px; font-weight: bold; color: ${analysisResult.priceChange >= 0 ? '#10b981' : '#ef4444'};">${analysisResult.priceChange >= 0 ? '+' : ''}${analysisResult.priceChange}%</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin: 12px 0;">
                        <h5>💰 محاسبات مالی</h5>
                        <div>سرمایه اولیه: $${amount.toLocaleString()}</div>
                        <div>سرمایه با اهرم: $${(amount * leverage).toLocaleString()}</div>
                        <div>حداکثر سود احتمالی: <span class="profit">+$${profitPotential}</span></div>
                        <div>حداکثر ضرر احتمالی: <span class="loss">-$${lossPotential}</span></div>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 12px; border-radius: 10px; margin: 12px 0;">
                    <strong>⚠️ هشدار ریسک:</strong> این تحلیل صرفاً جنبه آموزشی دارد و توصیه مالی محسوب نمی‌شود. 
                    معاملات اهرمی ریسک بالایی دارند و ممکن است منجر به از دست دادن کل سرمایه شوند.
                </div>
            `;
        }

        // شبیه‌سازی پیشرفت تحلیل
        function simulateAnalysisProgress() {
            return new Promise((resolve) => {
                const progressFill = document.querySelector('.progress-fill');
                let progress = 0;
                
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        resolve();
                    }
                    progressFill.style.width = progress + '%';
                }, 200);
            });
        }

        // به روزرسانی اهرم در ماشین حساب
        function updateCalcLeverage() {
            const leverage = document.getElementById('calcLeverage').value;
            document.getElementById('calcLeverageValue').textContent = leverage + 'x';
            calculateTrade();
        }

        // محاسبه معامله
        function calculateTrade() {
            const amount = parseFloat(document.getElementById('calcAmount').value) || 1000;
            const leverage = parseInt(document.getElementById('calcLeverage').value);
            const priceChange = parseFloat(document.getElementById('calcPriceChange').value);
            const position = document.getElementById('calcPosition').value;
            
            const leveragedAmount = amount * leverage;
            const profit = (leveragedAmount * priceChange / 100).toFixed(2);
            const loss = (leveragedAmount * priceChange / 100).toFixed(2);
            
            document.getElementById('calcInitial').textContent = `$${amount.toLocaleString()}`;
            document.getElementById('calcLeveraged').textContent = `$${leveragedAmount.toLocaleString()}`;
            document.getElementById('calcProfit').textContent = `+$${profit}`;
            document.getElementById('calcLoss').textContent = `-$${loss}`;
        }

        // به روزرسانی قیمت در ماشین حساب
        function updateCalcPrice() {
            calculateTrade();
        }

        // مدیریت مراحل فرم هوش مصنوعی Mousa
        function nextStep(step) {
            if (validateStep(step)) {
                document.querySelectorAll('.form-step').forEach(stepEl => {
                    stepEl.classList.remove('active');
                });
                
                currentStep = step + 1;
                const nextStepEl = document.getElementById(`step${currentStep}`);
                if (nextStepEl) {
                    nextStepEl.classList.add('active');
                    
                    if (currentStep === 2) {
                        populateSymbols();
                    }
                    
                    updateSelectionSummary();
                }
            }
        }

        function prevStep(step) {
            document.querySelectorAll('.form-step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            currentStep = step - 1;
            const prevStepEl = document.getElementById(`step${currentStep}`);
            if (prevStepEl) {
                prevStepEl.classList.add('active');
            }
        }

        // اعتبارسنجی هر مرحله
        function validateStep(step) {
            switch(step) {
                case 1:
                    const marketSelect = document.getElementById('marketSelect');
                    const market = marketSelect.value;
                    if (!market) {
                        alert('لطفا بازار مورد نظر را انتخاب کنید');
                        marketSelect.focus();
                        return false;
                    }
                    userSelections.market = market;
                    return true;
                    
                case 2:
                    const symbolSelect = document.getElementById('symbolSelect');
                    const symbol = symbolSelect.value;
                    if (!symbol) {
                        alert('لطفا نماد معاملاتی را انتخاب کنید');
                        symbolSelect.focus();
                        return false;
                    }
                    userSelections.symbol = symbol;
                    return true;
                    
                case 3:
                    const amount = document.getElementById('investmentAmount').value;
                    if (!amount || amount < 10) {
                        alert('لطفا مقدار سرمایه معتبر وارد کنید (حداقل 10 دلار)');
                        document.getElementById('investmentAmount').focus();
                        return false;
                    }
                    userSelections.amount = amount;
                    return true;
                    
                default:
                    return true;
            }
        }

        // پر کردن نمادها
        function populateSymbols() {
            const select = document.getElementById('symbolSelect');
            select.innerHTML = '<option value="">-- لطفا نماد را انتخاب کنید --</option>';
            
            const market = userSelections.market;
            if (symbolsData[market]) {
                symbolsData[market].forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    select.appendChild(option);
                });
            }
        }

        // به‌روزرسانی خلاصه انتخاب‌ها
        function updateSelectionSummary() {
            const summaryDiv = document.getElementById('selectionSummary');
            const summaryContent = document.getElementById('summaryContent');
            
            if (Object.keys(userSelections).length > 0) {
                let html = '<div class="summary-grid">';
                
                if (userSelections.market) {
                    html += `<div class="summary-item"><strong>بازار:</strong> ${userSelections.market}</div>`;
                }
                
                if (userSelections.symbol) {
                    html += `<div class="summary-item"><strong>نماد:</strong> ${userSelections.symbol}</div>`;
                }
                
                if (userSelections.amount) {
                    html += `<div class="summary-item"><strong>سرمایه:</strong> ${userSelections.amount} دلار</div>`;
                }
                
                html += '</div>';
                summaryContent.innerHTML = html;
                summaryDiv.style.display = 'block';
            }
        }

        // اجرای تحلیل هوش مصنوعی Mousa
        function runMousaAIAnalysis() {
            const timeframe = document.getElementById('timeframeSelect').value;
            if (!timeframe) {
                alert('لطفا بازه زمانی را انتخاب کنید');
                return;
            }
            
            userSelections.timeframe = timeframe;
            
            // نمایش وضعیت تحلیل
            const resultsDiv = document.getElementById('mousaAIResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="analysis-progress">
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px;">
                        <h4>🧠 در حال اجرای تحلیل پیشرفته هوش مصنوعی Mousa...</h4>
                        <div style="margin-top: 12px;">
                            <div>🔍 جمع‌آوری داده‌های بازار</div>
                            <div>📊 تحلیل تکنیکال (35 اندیکاتور)</div>
                            <div>📰 تحلیل اخبار و سنتیمنت</div>
                            <div>🤖 پردازش هوش مصنوعی پیشرفته</div>
                            <div>🎯 محاسبه احتمال و اهداف معاملاتی</div>
                        </div>
                        <div class="progress-bar" style="margin-top: 10px;">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // شبیه‌سازی پیشرفت
            simulateMousaAnalysisProgress();
        }

        // شبیه‌سازی پیشرفت تحلیل Mousa
        function simulateMousaAnalysisProgress() {
            const progressFill = document.querySelector('.progress-fill');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        showMousaAdvancedResults();
                    }, 500);
                }
                progressFill.style.width = progress + '%';
            }, 300);
        }

        // نمایش نتایج پیشرفته Mousa
        function showMousaAdvancedResults() {
            const resultsDiv = document.getElementById('mousaAIResults');
            const analysisResult = generateMousaAdvancedAnalysis();
            
            // ذخیره نتایج در localStorage
            saveAnalysisResult(analysisResult);
            
            resultsDiv.innerHTML = `
                <div class="advanced-results">
                    <h4>🧠 نتایج تحلیل پیشرفته هوش مصنوعی Mousa</h4>
                    
                    <!-- کارت نتیجه نهایی -->
                    <div class="final-prediction ${analysisResult.decisionColor}">
                        <div class="prediction-header">
                            <div class="symbol-info">
                                <h3 style="font-size: 1.2rem;">${userSelections.symbol}</h3>
                                <small>${userSelections.market} - ${getTimeframeLabel(userSelections.timeframe)}</small>
                            </div>
                            <div class="timeframe">⏰ ${getTimeframeLabel(userSelections.timeframe)}</div>
                        </div>
                        
                        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                            <div class="probability-circle">
                                <div class="circle-value">${analysisResult.probability}%</div>
                                <div class="circle-label">احتمال موفقیت</div>
                            </div>
                            
                            <div class="decision">
                                <div class="decision-text">${analysisResult.decision}</div>
                                <div class="decision-subtext">${analysisResult.confidence}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- اهداف معاملاتی -->
                    <div class="trading-targets-grid">
                        <div class="target-card profit">
                            <div class="target-icon">🎯</div>
                            <div class="target-label">حد سود</div>
                            <div class="target-value">${analysisResult.targets.takeProfit}</div>
                        </div>
                        
                        <div class="target-card loss">
                            <div class="target-icon">🛡️</div>
                            <div class="target-label">حد ضرر</div>
                            <div class="target-value">${analysisResult.targets.stopLoss}</div>
                        </div>
                        
                        <div class="target-card time">
                            <div class="target-icon">⏱️</div>
                            <div class="target-label">زمان بازدهی</div>
                            <div class="target-value">${analysisResult.targets.timeToResult}</div>
                        </div>
                        
                        <div class="target-card risk">
                            <div class="target-icon">📊</div>
                            <div class="target-label">سطح ریسک</div>
                            <div class="target-value" style="color: ${analysisResult.riskLevel === 'بالا' ? '#ef4444' : analysisResult.riskLevel === 'متوسط' ? '#f59e0b' : '#10b981'}">
                                ${analysisResult.riskLevel}
                            </div>
                        </div>
                    </div>
                    
                    <!-- تحلیل‌های جزئی -->
                    <div style="margin-top: 20px;">
                        <h5>📈 تحلیل‌های جزئی</h5>
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <div style="font-weight: bold; margin-bottom: 8px;">تکنیکال</div>
                                <div class="analysis-score ${analysisResult.scores.technical >= 70 ? 'good' : analysisResult.scores.technical >= 50 ? 'average' : 'poor'}">
                                    ${analysisResult.scores.technical}/100
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; margin-top: 8px;">
                                    ${analysisResult.details.technical.join('<br>')}
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <div style="font-weight: bold; margin-bottom: 8px;">سنتیمنت</div>
                                <div class="analysis-score ${analysisResult.scores.sentiment >= 70 ? 'good' : analysisResult.scores.sentiment >= 50 ? 'average' : 'poor'}">
                                    ${analysisResult.scores.sentiment}/100
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; margin-top: 8px;">
                                    ${analysisResult.details.sentiment.join('<br>')}
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <div style="font-weight: bold; margin-bottom: 8px;">اخبار</div>
                                <div class="analysis-score ${analysisResult.scores.news >= 70 ? 'good' : analysisResult.scores.news >= 50 ? 'average' : 'poor'}">
                                    ${analysisResult.scores.news}/100
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; margin-top: 8px;">
                                    ${analysisResult.details.news.join('<br>')}
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <div style="font-weight: bold; margin-bottom: 8px;">هوش مصنوعی</div>
                                <div class="analysis-score ${analysisResult.scores.ai >= 70 ? 'good' : analysisResult.scores.ai >= 50 ? 'average' : 'poor'}">
                                    ${analysisResult.scores.ai}/100
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; margin-top: 8px;">
                                    ${analysisResult.details.ai.join('<br>')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- توصیه‌ها -->
                    <div style="margin-top: 20px;">
                        <h5>💡 توصیه‌های معاملاتی</h5>
                        <div class="recommendation-list">
                            ${analysisResult.recommendations.map(rec => `
                                <div class="recommendation-item">
                                    <span>${rec}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- دکمه‌های action -->
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="btn" onclick="restartAnalysis()" style="background: #6b7280;">
                            🔄 شروع مجدد
                        </button>
                        <button class="btn" onclick="saveCurrentAnalysis()" style="background: #10b981;">
                            💾 ذخیره تحلیل
                        </button>
                        <button class="btn" onclick="viewSavedAnalyses()" style="background: #3b82f6;">
                            📊 مشاهده تحلیل‌های ذخیره شده
                        </button>
                    </div>
                    
                    <!-- هشدار ریسک -->
                    <div class="risk-warning">
                        <div>⚠️</div>
                        <div>
                            <strong>هشدار ریسک:</strong> این تحلیل صرفاً جنبه آموزشی دارد و توصیه مالی محسوب نمی‌شود. 
                            سرمایه‌گذاری در بازارهای مالی دارای ریسک است و ممکن است منجر به از دست دادن سرمایه شود.
                        </div>
                    </div>
                </div>
            `;
        }

        // تابع کمکی برای تولید تحلیل پیشرفته Mousa
        function generateMousaAdvancedAnalysis() {
            const probability = Math.floor(Math.random() * 30 + 65); // 65-95%
            const decision = probability >= 75 ? 'خرید' : probability >= 60 ? 'نگهداری' : 'فروش';
            const decisionColor = decision === 'خرید' ? '' : decision === 'فروش' ? 'danger' : 'warning';
            
            return {
                probability: probability,
                decision: decision,
                decisionColor: decisionColor,
                confidence: probability >= 80 ? 'اطمینان بسیار بالا' : 
                            probability >= 70 ? 'اطمینان بالا' : 
                            probability >= 60 ? 'اطمینان متوسط' : 'اطمینان پایین',
                riskLevel: probability >= 80 ? 'پایین' : 
                          probability >= 65 ? 'متوسط' : 'بالا',
                targets: {
                    takeProfit: (Math.random() * 20 + 5).toFixed(1) + '%',
                    stopLoss: (Math.random() * 8 + 2).toFixed(1) + '%',
                    timeToResult: userSelections.timeframe === '5min' ? '15-30 دقیقه' :
                                 userSelections.timeframe === '1h' ? '2-4 ساعت' :
                                 userSelections.timeframe === '1d' ? '1-3 روز' : '3-7 روز'
                },
                scores: {
                    technical: Math.floor(Math.random() * 30 + 65),
                    sentiment: Math.floor(Math.random() * 30 + 60),
                    news: Math.floor(Math.random() * 35 + 55),
                    ai: Math.floor(Math.random() * 25 + 70)
                },
                details: {
                    technical: ['RSI در منطقه مناسب', 'MACD مثبت', 'حجم معاملات افزایشی'],
                    sentiment: ['سنتیمنت بازار مثبت', 'شاخص ترس و طمع: 65', 'حجم اجتماعی بالا'],
                    news: ['اخبار اقتصادی مثبت', 'عدم رویداد مهم منفی', 'تحلیل‌های خوشبینانه'],
                    ai: ['الگوی صعودی شناسایی شد', 'اعتماد مدل: 87%', 'همخوانی با داده‌های تاریخی']
                },
                recommendations: [
                    'حد ضرر را دقیق رعایت کنید',
                    'پوزیشن‌سازی مرحله‌ای انجام دهید',
                    'اخبار بازار را دنبال کنید',
                    'تحلیل را در بازه‌های زمانی مختلف بررسی کنید'
                ]
            };
        }

        // توابع کمکی برای نمایش برچسب‌ها
        function getTimeframeLabel(timeframe) {
            const labels = {
                '5min': '5 دقیقه',
                '15min': '15 دقیقه',
                '1h': '1 ساعت',
                '4h': '4 ساعت',
                '1d': '1 روز',
                '3d': '3 روز',
                '1w': '1 هفته'
            };
            return labels[timeframe] || timeframe;
        }

        // ذخیره تحلیل
        function saveAnalysisResult(result) {
            const savedAnalyses = JSON.parse(localStorage.getItem('mousaSavedAnalyses') || '[]');
            
            const analysisData = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('fa-IR'),
                symbol: userSelections.symbol,
                market: userSelections.market,
                amount: userSelections.amount,
                timeframe: userSelections.timeframe,
                result: result,
                userSelections: {...userSelections}
            };
            
            savedAnalyses.unshift(analysisData); // اضافه به ابتدای لیست
            localStorage.setItem('mousaSavedAnalyses', JSON.stringify(savedAnalyses.slice(0, 100))); // محدودیت 100 تحلیل
            
            showNotification('✅ تحلیل با موفقیت ذخیره شد');
        }

        // شروع مجدد
        function restartAnalysis() {
            currentStep = 1;
            userSelections = {};
            
            document.querySelectorAll('.form-step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            document.getElementById('step1').classList.add('active');
            document.getElementById('selectionSummary').style.display = 'none';
            document.getElementById('mousaAIResults').style.display = 'none';
            
            showNotification('🔄 تحلیل جدید شروع شد');
        }

        function saveCurrentAnalysis() {
            showNotification('✅ تحلیل فعلی ذخیره شد');
        }

        // مشاهده تحلیل‌های ذخیره شده
        function viewSavedAnalyses() {
            showTab('tab-saved-analyses');
        }

        // بارگذاری تحلیل‌های ذخیره شده
        function loadSavedAnalyses() {
            const savedAnalyses = JSON.parse(localStorage.getItem('mousaSavedAnalyses') || '[]');
            const listDiv = document.getElementById('savedAnalysesList');
            
            if (savedAnalyses.length === 0) {
                listDiv.innerHTML = '<div class="loading">هیچ تحلیلی ذخیره نشده است</div>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            savedAnalyses.forEach(analysis => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e5e7eb;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <h4>${analysis.symbol} - ${analysis.market}</h4>
                            <div>
                                <small style="color: #6b7280;">${analysis.timestamp}</small>
                                <button onclick="deleteAnalysis(${analysis.id})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                                    حذف
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div><strong>سرمایه:</strong> $${analysis.amount}</div>
                            <div><strong>بازه زمانی:</strong> ${getTimeframeLabel(analysis.timeframe)}</div>
                            <div><strong>توصیه:</strong> ${analysis.result.decision}</div>
                            <div><strong>احتمال:</strong> ${analysis.result.probability}%</div>
                        </div>
                        
                        <button onclick="viewAnalysisDetails(${analysis.id})" class="btn" style="width: auto; padding: 8px 15px;">
                            مشاهده جزئیات
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            listDiv.innerHTML = html;
        }

        // حذف تحلیل
        function deleteAnalysis(id) {
            const savedAnalyses = JSON.parse(localStorage.getItem('mousaSavedAnalyses') || '[]');
            const filtered = savedAnalyses.filter(a => a.id !== id);
            localStorage.setItem('mousaSavedAnalyses', JSON.stringify(filtered));
            loadSavedAnalyses();
            showNotification('تحلیل حذف شد');
        }

        // حذف همه تحلیل‌ها
        function clearAllAnalyses() {
            if (confirm('آیا از حذف تمام تحلیل‌های ذخیره شده اطمینان دارید؟')) {
                localStorage.removeItem('mousaSavedAnalyses');
                loadSavedAnalyses();
                showNotification('تمام تحلیل‌ها حذف شدند');
            }
        }

        function viewAnalysisDetails(id) {
            const savedAnalyses = JSON.parse(localStorage.getItem('mousaSavedAnalyses') || '[]');
            const analysis = savedAnalyses.find(a => a.id === id);
            
            if (analysis) {
                alert(`جزئیات تحلیل:\n\nنماد: ${analysis.symbol}\nبازار: ${analysis.market}\nسرمایه: $${analysis.amount}\nبازه زمانی: ${analysis.timeframe}\nتوصیه: ${analysis.result.decision}\nاحتمال: ${analysis.result.probability}%`);
            }
        }

        // رویدادهای محاسبه خودکار
        document.getElementById('calcAmount').addEventListener('input', calculateTrade);
        document.getElementById('calcLeverage').addEventListener('input', calculateTrade);
        document.getElementById('calcPriceChange').addEventListener('input', calculateTrade);
        document.getElementById('calcPosition').addEventListener('change', calculateTrade);
    </script>
</body>
</html>